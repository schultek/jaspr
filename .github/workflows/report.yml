on:
  pull_request_target:
    branches:
      - main
    paths:
      - '.github/workflows/report.yml'
      - 'packages/**'

name: Report Pipeline

jobs:
  report:
    name: Version Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          ref: "refs/pull/${{ github.event.number }}/merge"

      - uses: subosito/flutter-action@v2
        with:
          channel: beta # remove once Flutter stable supports analyzer 8

      - name: Bootstrap
        run: |
          flutter doctor
          dart pub global activate melos
          dart pub global activate -s git https://github.com/schultek/semantic_changelog
          melos bootstrap --no-private
          jaspr --disable-analytics

      - name: Bump Package Versions
        id: bump
        run: |
          version bump --dry-run --scope="packages/*" | tee output.txt
          echo 'version_report<<EOF' >> $GITHUB_OUTPUT
          echo '## Package Version Report' >> $GITHUB_OUTPUT
          cat output.txt >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          rm -rf output.txt

      - name: Create PR comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: ${{ steps.bump.outputs.version_report }}
          comment_tag: version_report
